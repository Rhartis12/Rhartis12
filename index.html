<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OSCC Alpha Deck</title>
    <script src="https://cdn.plot.ly/plotly-2.27.0.min.js"></script>
    <style>
        /* --- Í∏∞Î≥∏ ÌÖåÎßà --- */
        :root { --bg: #0f172a; --card: #1e293b; --text: #f1f5f9; --subtext: #94a3b8; --border: #334155; --call: #10b981; --put: #ef4444; --accent: #3b82f6; }
        body { background-color: var(--bg); color: var(--text); font-family: 'Segoe UI', Roboto, Helvetica, sans-serif; margin: 0; padding: 0; }
        .container { max-width: 1200px; margin: 0 auto; padding: 20px; }
        
        /* Ìó§Îçî & Î¶¨Î≥∏ */
        header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; border-bottom: 1px solid var(--border); padding-bottom: 15px; }
        h1 { margin: 0; font-size: 24px; background: linear-gradient(90deg, #60a5fa, #a78bfa); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        select#tickerSelect { background: var(--card); color: white; border: 1px solid var(--border); padding: 8px 16px; border-radius: 6px; outline: none; }
        
        .ribbon-container { overflow-x: auto; white-space: nowrap; padding-bottom: 10px; margin-bottom: 20px; }
        .ribbon-btn { display: inline-block; background: var(--card); color: var(--subtext); border: 1px solid var(--border); padding: 8px 16px; margin-right: 8px; border-radius: 20px; cursor: pointer; font-size: 14px; transition: all 0.2s; }
        .ribbon-btn:hover { border-color: var(--accent); color: white; }
        .ribbon-btn.active { background: var(--accent); color: white; border-color: var(--accent); font-weight: bold; }

        /* AI Ïπ¥Îìú */
        .ai-card { background: linear-gradient(180deg, rgba(30,41,59,0.8) 0%, rgba(15,23,42,1) 100%); border: 1px solid var(--border); border-left: 4px solid var(--accent); border-radius: 12px; padding: 20px; margin-bottom: 30px; }
        .ai-title { font-size: 18px; font-weight: bold; color: var(--accent); margin-bottom: 10px; display: flex; align-items: center; gap: 10px; }
        .ai-body { font-size: 15px; line-height: 1.6; color: #cbd5e1; white-space: pre-line; }
        .badge { font-size: 12px; padding: 4px 8px; border-radius: 4px; background: #334155; color: white; margin-left: auto; }

        /* Ï∞®Ìä∏ */
        .chart-box { background: var(--card); border: 1px solid var(--border); border-radius: 12px; padding: 15px; margin-bottom: 20px; height: 500px; position: relative; }
        .chart-title { position: absolute; top: 15px; left: 20px; font-weight: bold; color: var(--subtext); z-index: 10; pointer-events: none; }

        /* ÌÖåÏù¥Î∏î */
        .table-section { background: var(--card); border: 1px solid var(--border); border-radius: 12px; overflow: hidden; }
        .table-header { padding: 15px 20px; font-weight: bold; border-bottom: 1px solid var(--border); background: #253347; }
        .table-scroll { overflow-x: auto; max-height: 800px; }
        table { width: 100%; border-collapse: collapse; font-size: 13px; min-width: 800px; }
        th { background: #0f172a; color: var(--subtext); padding: 12px 8px; font-weight: 600; position: sticky; top: 0; z-index: 5; }
        
        th.group-call { border-bottom: 2px solid var(--call); color: var(--call); }
        th.group-put { border-bottom: 2px solid var(--put); color: var(--put); }
        th.group-strike { border-bottom: 2px solid #fff; color: white; background: #1e293b; }
        
        td { padding: 8px 8px; border-bottom: 1px solid #334155; white-space: nowrap; }
        .col-call { text-align: right; color: #cbd5e1; } .col-put { text-align: left; color: #cbd5e1; }
        .col-strike { text-align: center; font-weight: bold; background: #253347; color: white; }
        .val-call { color: var(--call); } .val-put { color: var(--put); }
        
        /* ÌòÑÏû¨Í∞Ä Ìñâ (Insert Row) Ïä§ÌÉÄÏùº */
        .current-price-row td { background-color: rgba(255, 215, 0, 0.15); color: #ffd700; font-weight: bold; text-align: center; border-top: 1px dashed #ffd700; border-bottom: 1px dashed #ffd700; padding: 10px 0; }
    </style>
</head>
<body>

<div class="container">
    <header>
        <h1>üöÄ OSCC Alpha Deck</h1>
        <select id="tickerSelect"></select>
    </header>

    <div id="ribbonMenu" class="ribbon-container"></div>

    <div class="ai-card" id="aiSection">
        <div class="ai-title">
            <span>ü§ñ AI Tactical Insight</span>
            <span class="badge" id="aiExpiryBadge">Target: --</span>
        </div>
        <div class="ai-body" id="aiBody">Loading strategy...</div>
    </div>

    <div class="chart-section">
        <div class="chart-box">
            <div class="chart-title">üìä Net Gamma Exposure (GEX Map)</div>
            <div id="chartGEX" style="width:100%; height:100%;"></div>
        </div>
        <div class="chart-box">
            <div class="chart-title">üß± Open Interest Walls (OI)</div>
            <div id="chartOI" style="width:100%; height:100%;"></div>
        </div>
    </div>

    <div class="table-section">
        <div class="table-header">üìã Option Chain Details</div>
        <div class="table-scroll">
            <table id="chainTable">
                <thead>
                    <tr>
                        <th class="group-call">GEX ($)</th><th class="group-call">OI</th><th class="group-call">Vol</th><th class="group-call">IV</th>
                        <th class="group-strike">STRIKE</th>
                        <th class="group-put">IV</th><th class="group-put">Vol</th><th class="group-put">OI</th><th class="group-put">GEX ($)</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>
    </div>
</div>

<script>
    let rawData = [], aiData = {};

    async function init() {
        try {
            const [resGex, resAi] = await Promise.all([fetch('dashboard_gex_details.json'), fetch('dashboard_ai.json')]);
            rawData = await resGex.json(); aiData = await resAi.json();
            const tickers = [...new Set(rawData.map(d => d.ticker))].sort();
            const sel = document.getElementById('tickerSelect');
            tickers.forEach(t => { let opt = document.createElement('option'); opt.value = t; opt.text = `$${t}`; sel.appendChild(opt); });
            sel.addEventListener('change', () => updateRibbon(true));
            if(tickers.length > 0) updateRibbon(true);
        } catch(e) { console.error(e); document.body.innerHTML = "<h2 style='text-align:center; color:white'>Data Load Failed.</h2>"; }
    }

    function updateRibbon(reset) {
        const ticker = document.getElementById('tickerSelect').value;
        const ribbon = document.getElementById('ribbonMenu');
        ribbon.innerHTML = '';
        const expiries = [...new Set(rawData.filter(d => d.ticker === ticker).map(d => d.expiry))].sort();
        expiries.forEach((date, idx) => {
            const btn = document.createElement('div');
            btn.className = 'ribbon-btn'; btn.innerText = date;
            btn.onclick = () => { document.querySelectorAll('.ribbon-btn').forEach(b=>b.classList.remove('active')); btn.classList.add('active'); renderDashboard(ticker, date); };
            ribbon.appendChild(btn);
            if (reset && idx === 0) btn.click();
        });
    }

    function renderDashboard(ticker, expiry) {
        const aiInfo = aiData[ticker];
        let currentPrice = 0;
        
        if (aiInfo) {
            document.getElementById('aiExpiryBadge').innerText = `Target: ${aiInfo.expiry || 'N/A'}`;
            document.getElementById('aiBody').innerHTML = `<strong>[${aiInfo.sentiment}] ${aiInfo.title}</strong>\n\n${aiInfo.body}`;
            currentPrice = aiInfo.price;
        } else {
            document.getElementById('aiExpiryBadge').innerText = `Target: --`;
            document.getElementById('aiBody').innerText = "AI Analysis not available.";
        }

        const data = rawData.filter(d => d.ticker === ticker && d.expiry === expiry);
        if(currentPrice === 0 && data.length > 0) currentPrice = data[0].strike; 

        drawCharts(data, currentPrice);
        drawOptionChain(data, currentPrice);
    }

    function drawCharts(data, currentPrice) {
        // ÏÉÅÏúÑ 40Í∞ú ÌñâÏÇ¨Í∞Ä ÌïÑÌÑ∞ÎßÅ (GEX Ï†àÎåÄÍ∞í Í∏∞Ï§Ä)
        const strikeMap = new Map();
        data.forEach(d => { strikeMap.set(d.strike, (strikeMap.get(d.strike) || 0) + Math.abs(d.gex_notional)); });
        const topStrikes = Array.from(strikeMap.entries()).sort((a, b) => b[1] - a[1]).slice(0, 40).map(e => e[0]);
        const filteredData = data.filter(d => topStrikes.includes(d.strike));

        const calls = filteredData.filter(d => d.type === 'call').sort((a,b) => a.strike - b.strike);
        const puts = filteredData.filter(d => d.type === 'put').sort((a,b) => a.strike - b.strike);

        const layoutBase = {
            barmode: 'relative', paper_bgcolor: 'rgba(0,0,0,0)', plot_bgcolor: 'rgba(0,0,0,0)',
            font: {color: '#94a3b8'}, margin: {t:40, b:30, l:60, r:20},
            xaxis: {gridcolor: '#334155', zerolinecolor: '#fff'},
            yaxis: {gridcolor: '#334155'},
            // ‚≠ê [ÏàòÏ†ï] Ï∞®Ìä∏Í∞Ä Í∞ÄÎ°úÌòï(YÏ∂ï=Strike)Ïù¥ÎØÄÎ°ú, ÏÑ†ÏùÄ Í∞ÄÎ°úÏÑ†(Horizontal)Ïù¥Ïñ¥Ïïº Ìï®
            shapes: currentPrice > 0 ? [{
                type: 'line', 
                x0: 0, x1: 1, xref: 'paper', // Ï∞®Ìä∏ Ï†ÑÏ≤¥ ÎÑàÎπÑ
                y0: currentPrice, y1: currentPrice, yref: 'y', // ÌäπÏ†ï Y ÎÜíÏù¥ (Í∞ÄÍ≤©)
                line: { color: '#ffd700', width: 2, dash: 'dot' }
            }] : []
        };

        // GEX Chart
        Plotly.newPlot('chartGEX', [
            { x: puts.map(d=>d.gex_notional), y: puts.map(d=>d.strike), type: 'bar', orientation: 'h', name: 'Put GEX', marker:{color:'#ef4444'} },
            { x: calls.map(d=>d.gex_notional), y: calls.map(d=>d.strike), type: 'bar', orientation: 'h', name: 'Call GEX', marker:{color:'#10b981'} }
        ], { ...layoutBase, xaxis: { ...layoutBase.xaxis, title: 'Net Gamma ($)' } }, {responsive: true, displayModeBar: false});

        // OI Chart
        Plotly.newPlot('chartOI', [
            { x: puts.map(d=>d.openInterest), y: puts.map(d=>d.strike), type: 'bar', orientation: 'h', name: 'Put OI', marker:{color:'#dc2626', opacity:0.7} },
            { x: calls.map(d=>d.openInterest), y: calls.map(d=>d.strike), type: 'bar', orientation: 'h', name: 'Call OI', marker:{color:'#059669', opacity:0.7} }
        ], { ...layoutBase, xaxis: { ...layoutBase.xaxis, title: 'Open Interest' } }, {responsive: true, displayModeBar: false});
    }

    function drawOptionChain(data, currentPrice) {
        const tbody = document.querySelector('#chainTable tbody'); tbody.innerHTML = '';
        const strikeMap = {};
        data.forEach(d => { if(!strikeMap[d.strike]) strikeMap[d.strike] = {call:null, put:null}; strikeMap[d.strike][d.type] = d; });
        
        // ÌñâÏÇ¨Í∞Ä Ï†ïÎ†¨
        const strikes = Object.keys(strikeMap).map(Number).sort((a,b) => a - b);
        
        const num = (n) => n ? n.toLocaleString() : '-';
        const gex = (n) => n ? (n/1000).toFixed(0)+'k' : '-';
        const iv = (n) => n ? (n*100).toFixed(1)+'%' : '-';

        // ‚≠ê [ÏàòÏ†ï] ÌÖåÏù¥Î∏î Ï§ëÍ∞ÑÏóê ÌòÑÏû¨Í∞Ä Row ÏÇΩÏûÖ Î°úÏßÅ
        let priceInserted = false;

        strikes.forEach(k => {
            // ÌòÑÏû¨Í∞ÄÍ∞Ä Ïù¥ ÌñâÏÇ¨Í∞ÄÎ≥¥Îã§ ÏûëÍ≥†, ÏïÑÏßÅ ÏÇΩÏûÖ ÏïàÎêêÎã§Î©¥ -> ÏÇΩÏûÖ
            if (!priceInserted && currentPrice < k) {
                const priceRow = document.createElement('tr');
                priceRow.className = 'current-price-row';
                priceRow.innerHTML = `<td colspan="9">‚ö° Current Price: $${currentPrice.toFixed(2)} ‚ö°</td>`;
                tbody.appendChild(priceRow);
                priceInserted = true;
            }

            const row = document.createElement('tr'); 
            const c = strikeMap[k].call || {}, p = strikeMap[k].put || {};
            row.innerHTML = `<td class="col-call val-call">${gex(c.gex_notional)}</td><td class="col-call">${num(c.openInterest)}</td><td class="col-call">${num(c.volume)}</td><td class="col-call">${iv(c.impliedVolatility)}</td><td class="col-strike">${k}</td><td class="col-put">${iv(p.impliedVolatility)}</td><td class="col-put">${num(p.volume)}</td><td class="col-put">${num(p.openInterest)}</td><td class="col-put val-put">${gex(p.gex_notional)}</td>`;
            tbody.appendChild(row);
        });
        
        // ÎßåÏïΩ ÌòÑÏû¨Í∞ÄÍ∞Ä Î™®Îì† ÌñâÏÇ¨Í∞ÄÎ≥¥Îã§ ÌÅ¨Îã§Î©¥ Îß® ÎßàÏßÄÎßâÏóê Ï∂îÍ∞Ä
        if (!priceInserted) {
            const priceRow = document.createElement('tr');
            priceRow.className = 'current-price-row';
            priceRow.innerHTML = `<td colspan="9">‚ö° Current Price: $${currentPrice.toFixed(2)} ‚ö°</td>`;
            tbody.appendChild(priceRow);
        }
    }
    init();
</script>
</body>
</html>
