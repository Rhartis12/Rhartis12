<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OSCC Alpha Deck</title>
    <script src="https://cdn.plot.ly/plotly-2.27.0.min.js"></script>
    <style>
        /* --- ÌÖåÎßà ÏÑ§Ï†ï --- */
        :root { --bg: #0f172a; --card: #1e293b; --text: #f1f5f9; --subtext: #94a3b8; --border: #334155; --call: #10b981; --put: #ef4444; --accent: #3b82f6; }
        body { background-color: var(--bg); color: var(--text); font-family: 'Segoe UI', sans-serif; margin: 0; padding: 20px; }
        
        /* Ìó§Îçî */
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; border-bottom: 1px solid var(--border); padding-bottom: 15px; }
        h1 { margin: 0; font-size: 24px; color: var(--accent); }
        select { background: var(--card); color: white; border: 1px solid var(--border); padding: 8px 16px; border-radius: 6px; font-size: 16px; }

        /* Î¶¨Î≥∏ Î©îÎâ¥ */
        .ribbon-container { overflow-x: auto; white-space: nowrap; margin-bottom: 20px; padding-bottom: 5px; }
        .ribbon-btn { display: inline-block; background: var(--card); color: var(--subtext); border: 1px solid var(--border); padding: 6px 14px; margin-right: 8px; border-radius: 20px; cursor: pointer; font-size: 13px; transition: 0.2s; }
        .ribbon-btn:hover, .ribbon-btn.active { background: var(--accent); color: white; border-color: var(--accent); }

        /* AI Ïπ¥Îìú */
        .ai-card { background: linear-gradient(180deg, rgba(30,41,59,0.8) 0%, #0f172a 100%); border: 1px solid var(--border); border-left: 4px solid var(--accent); border-radius: 12px; padding: 20px; margin-bottom: 30px; box-shadow: 0 4px 15px rgba(0,0,0,0.3); }
        .ai-title { font-size: 18px; font-weight: bold; color: var(--accent); margin-bottom: 10px; display: flex; align-items: center; gap: 10px; }
        .ai-body { font-size: 15px; line-height: 1.6; color: #cbd5e1; white-space: pre-line; }
        .badge { font-size: 12px; padding: 4px 8px; border-radius: 4px; background: #334155; color: white; margin-left: auto; }

        /* Ï∞®Ìä∏ ÏòÅÏó≠ */
        .chart-grid { display: grid; grid-template-columns: 1fr; gap: 20px; margin-bottom: 30px; }
        @media (min-width: 1000px) { .chart-grid { grid-template-columns: 1fr 1fr; } }
        .chart-box { background: var(--card); border: 1px solid var(--border); border-radius: 12px; padding: 15px; height: 500px; position: relative; }
        .chart-title { position: absolute; top: 15px; left: 20px; font-weight: bold; color: var(--subtext); font-size: 14px; z-index: 10; pointer-events: none; }

        /* ÌÖåÏù¥Î∏î ÏòÅÏó≠ & ÌÉÄÏûÑÌîÑÎ†àÏûÑ Ïä§ÏúÑÏπò */
        .table-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        .tf-group { display: flex; background: var(--card); border-radius: 6px; padding: 2px; border: 1px solid var(--border); }
        .tf-btn { background: transparent; color: var(--subtext); border: none; padding: 6px 12px; cursor: pointer; border-radius: 4px; font-size: 12px; font-weight: 600; }
        .tf-btn.active { background: var(--accent); color: white; }

        .table-scroll { overflow-x: auto; max-height: 800px; border-radius: 12px; border: 1px solid var(--border); }
        table { width: 100%; border-collapse: collapse; font-size: 13px; min-width: 900px; background: var(--card); }
        th { background: #0f172a; color: var(--subtext); padding: 12px 8px; font-weight: 600; position: sticky; top: 0; z-index: 5; text-align: center; }
        
        /* Í∑∏Î£π Ìó§Îçî ÏÉâÏÉÅ */
        .th-call { border-bottom: 2px solid var(--call); color: var(--call); }
        .th-put { border-bottom: 2px solid var(--put); color: var(--put); }
        .th-strike { background: #253347; color: white; border-bottom: 2px solid white; }

        td { padding: 8px; border-bottom: 1px solid var(--border); white-space: nowrap; }
        tr:hover td { background-color: #334155; }

        /* Ïª¨Îüº Ïä§ÌÉÄÏùº */
        .col-call { text-align: right; color: #cbd5e1; }
        .col-put { text-align: left; color: #cbd5e1; }
        .col-strike { text-align: center; font-weight: bold; background: #253347; color: white; width: 80px; }
        .val-call { color: var(--call); } .val-put { color: var(--put); }

        /* Î≥ÄÌôîÎüâ ÏÉâÏÉÅ */
        .diff-pos { color: var(--call); font-weight: bold; }
        .diff-neg { color: var(--put); font-weight: bold; }
        .diff-neu { color: #64748b; }

        /* ÌòÑÏû¨Í∞Ä Ìñâ */
        .current-price-row td { background: rgba(255, 215, 0, 0.15); color: #ffd700; font-weight: bold; text-align: center; border-top: 1px dashed #ffd700; border-bottom: 1px dashed #ffd700; padding: 8px 0; }
        .atm-row { background-color: rgba(255, 255, 255, 0.05); }
    </style>
</head>
<body>

    <div class="header">
        <h1>üöÄ OSCC Alpha Deck</h1>
        <select id="tickerSelect"></select>
    </div>

    <div id="ribbonMenu" class="ribbon-container"></div>

    <div class="ai-card">
        <div class="ai-title">
            <span>ü§ñ AI Tactical Insight</span>
            <span class="badge" id="aiBadge">Target: --</span>
        </div>
        <div class="ai-body" id="aiBody">Loading analysis...</div>
    </div>

    <div class="chart-grid">
        <div class="chart-box">
            <div class="chart-title">üìä Net Gamma Exposure (GEX Map)</div>
            <div id="chartGEX" style="width:100%; height:100%;"></div>
        </div>
        <div class="chart-box">
            <div class="chart-title">üß± Open Interest Walls (OI)</div>
            <div id="chartOI" style="width:100%; height:100%;"></div>
        </div>
    </div>

    <div class="table-header">
        <div style="font-weight:bold; color:white; font-size:18px;">üìã Option Chain Details</div>
        <div class="tf-group">
            <button class="tf-btn active" onclick="setTF('curr', this)">Current</button>
            <button class="tf-btn" onclick="setTF('1d', this)">1D Œî</button>
            <button class="tf-btn" onclick="setTF('1w', this)">1W Œî</button>
        </div>
    </div>
    
    <div class="table-scroll">
        <table id="chainTable">
            <thead>
                <tr>
                    <th class="th-call">GEX</th><th class="th-call">OI</th><th class="th-call">Vol</th><th class="th-call">IV</th>
                    <th class="th-strike">STRIKE</th>
                    <th class="th-put">IV</th><th class="th-put">Vol</th><th class="th-put">OI</th><th class="th-put">GEX</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>
    </div>

<script>
    let rawData = [], aiData = {}, summaryData = [];
    let currentTF = 'curr'; // 'curr', '1d', '1w'
    let currentTicker = '', currentExpiry = '';

    async function init() {
        try {
            // Îç∞Ïù¥ÌÑ∞ Î°úÎìú
            const [resGex, resAi, resSum] = await Promise.all([
                fetch('dashboard_gex_details.json'), 
                fetch('dashboard_ai.json'),
                fetch('dashboard_summary.json')
            ]);
            rawData = await resGex.json(); 
            aiData = await resAi.json();
            summaryData = await resSum.json();

            // Ï¢ÖÎ™© ÏÑ∏ÌåÖ
            const tickers = [...new Set(rawData.map(d => d.ticker))].sort();
            const sel = document.getElementById('tickerSelect');
            tickers.forEach(t => { let opt = document.createElement('option'); opt.value = t; opt.text = `$${t}`; sel.appendChild(opt); });
            
            sel.addEventListener('change', () => updateRibbon(true));
            if(tickers.length > 0) updateRibbon(true);

        } catch(e) { console.error(e); document.body.innerHTML = "<h2 style='color:white;text-align:center'>Data Load Failed.</h2>"; }
    }

    function updateRibbon(reset) {
        currentTicker = document.getElementById('tickerSelect').value;
        const ribbon = document.getElementById('ribbonMenu');
        ribbon.innerHTML = '';
        const expiries = [...new Set(rawData.filter(d => d.ticker === currentTicker).map(d => d.expiry))].sort();
        
        expiries.forEach((date, idx) => {
            const btn = document.createElement('div');
            btn.className = 'ribbon-btn'; btn.innerText = date;
            btn.onclick = () => { 
                document.querySelectorAll('.ribbon-btn').forEach(b=>b.classList.remove('active')); 
                btn.classList.add('active'); 
                currentExpiry = date;
                renderDashboard(); 
            };
            ribbon.appendChild(btn);
            if (reset && idx === 0) btn.click();
        });
    }

    function setTF(tf, btn) {
        currentTF = tf;
        document.querySelectorAll('.tf-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        renderDashboard(true); // true = redraw table only
    }

    function renderDashboard(tableOnly = false) {
        // 1. Í∞ÄÍ≤© Ï∞æÍ∏∞ (Summary -> AI -> Fallback)
        let price = 0;
        const sumInfo = summaryData.filter(d => d.ticker === currentTicker).pop();
        if(sumInfo) price = sumInfo.price;
        else if(aiData[currentTicker]) price = aiData[currentTicker].price;

        const data = rawData.filter(d => d.ticker === currentTicker && d.expiry === currentExpiry);
        if(price === 0 && data.length > 0) price = data[0].strike; 

        // 2. Î†åÎçîÎßÅ
        if(!tableOnly) {
            updateAI(price);
            drawCharts(data, price);
        }
        drawTable(data, price);
    }

    function updateAI(price) {
        const info = aiData[currentTicker];
        if (info) {
            document.getElementById('aiBadge').innerText = `Target: ${info.expiry || 'N/A'}`;
            document.getElementById('aiBody').innerHTML = `<strong>[${info.sentiment}] ${info.title}</strong>\n\n${info.body}`;
        } else {
            document.getElementById('aiBadge').innerText = "Target: --";
            document.getElementById('aiBody').innerText = "AI Analysis not available.";
        }
    }

    function drawCharts(data, price) {
        // ÏÉÅÏúÑ 40Í∞ú ÌñâÏÇ¨Í∞Ä (GEX Ï†àÎåÄÍ∞í Í∏∞Ï§Ä)
        const strikeMap = new Map();
        data.forEach(d => strikeMap.set(d.strike, (strikeMap.get(d.strike)||0) + Math.abs(d.gex_notional)));
        const topStrikes = Array.from(strikeMap.entries()).sort((a,b)=>b[1]-a[1]).slice(0,40).map(e=>e[0]);
        const filtered = data.filter(d => topStrikes.includes(d.strike));

        const calls = filtered.filter(d => d.type === 'call').sort((a,b) => a.strike - b.strike);
        const puts = filtered.filter(d => d.type === 'put').sort((a,b) => a.strike - b.strike);

        const layout = {
            barmode: 'relative', paper_bgcolor: 'rgba(0,0,0,0)', plot_bgcolor: 'rgba(0,0,0,0)',
            font: {color: '#94a3b8'}, margin: {t:40, b:30, l:60, r:20},
            xaxis: {gridcolor: '#334155', zerolinecolor: '#fff'},
            yaxis: {gridcolor: '#334155'},
            shapes: price > 0 ? [{type:'line', x0:0, x1:1, xref:'paper', y0:price, y1:price, yref:'y', line:{color:'#ffd700', width:2, dash:'dot'}}] : []
        };

        Plotly.newPlot('chartGEX', [
            { x: puts.map(d=>d.gex_notional), y: puts.map(d=>d.strike), type: 'bar', orientation: 'h', name: 'Put', marker:{color:'#ef4444'} },
            { x: calls.map(d=>d.gex_notional), y: calls.map(d=>d.strike), type: 'bar', orientation: 'h', name: 'Call', marker:{color:'#10b981'} }
        ], {...layout, xaxis:{...layout.xaxis, title:'Net Gamma ($)'}}, {responsive:true, displayModeBar:false});

        Plotly.newPlot('chartOI', [
            { x: puts.map(d=>d.openInterest), y: puts.map(d=>d.strike), type: 'bar', orientation: 'h', name: 'Put', marker:{color:'#dc2626', opacity:0.7} },
            { x: calls.map(d=>d.openInterest), y: calls.map(d=>d.strike), type: 'bar', orientation: 'h', name: 'Call', marker:{color:'#059669', opacity:0.7} }
        ], {...layout, xaxis:{...layout.xaxis, title:'Open Interest'}}, {responsive:true, displayModeBar:false});
    }

    function drawTable(data, price) {
        const tbody = document.querySelector('#chainTable tbody'); tbody.innerHTML = '';
        const strikeMap = {};
        data.forEach(d => { if(!strikeMap[d.strike]) strikeMap[d.strike] = {call:{}, put:{}}; strikeMap[d.strike][d.type] = d; });
        const strikes = Object.keys(strikeMap).map(Number).sort((a,b) => a - b);
        
        let closest = strikes[0], minDiff = Math.abs(price - closest);
        strikes.forEach(k => { const diff = Math.abs(price - k); if(diff < minDiff) { minDiff = diff; closest = k; } });

        // Ìè¨Îß∑ÌÑ∞
        const fmt = (val, type) => {
            if(val === undefined || val === null) return '-';
            
            // Current Î™®Îìú
            if(currentTF === 'curr') {
                if(type === 'gex') return (val/1000).toFixed(0) + 'k';
                if(type === 'iv') return (val*100).toFixed(1) + '%';
                return val.toLocaleString();
            }
            
            // Change Î™®Îìú
            if(val === 0) return '<span class="diff-neu">-</span>';
            const sign = val > 0 ? '+' : '';
            const cls = val > 0 ? 'diff-pos' : 'diff-neg';
            
            if(type === 'gex') return `<span class="${cls}">${sign}${(val/1000).toFixed(0)}k</span>`;
            if(type === 'iv') return `<span class="diff-neu">-</span>`; 
            return `<span class="${cls}">${sign}${val.toLocaleString()}</span>`;
        };

        let priceInserted = false;

        strikes.forEach(k => {
            // ÌòÑÏû¨Í∞Ä Ìñâ ÏÇΩÏûÖ
            if (!priceInserted && price < k) {
                const pr = document.createElement('tr'); pr.className = 'current-price-row';
                pr.innerHTML = `<td colspan="9">‚ö° Current Price: $${price.toFixed(2)} ‚ö°</td>`;
                tbody.appendChild(pr);
                priceInserted = true;
            }

            const row = document.createElement('tr');
            if(k === closest) row.className = 'atm-row';
            const c = strikeMap[k].call, p = strikeMap[k].put;

            // Îç∞Ïù¥ÌÑ∞ ÌïÑÎìú ÏÑ†ÌÉù (raw or change)
            let c_gex, c_oi, c_vol, p_gex, p_oi, p_vol;
            if(currentTF === 'curr') {
                c_gex = c.gex_notional; c_oi = c.openInterest; c_vol = c.volume;
                p_gex = p.gex_notional; p_oi = p.openInterest; p_vol = p.volume;
            } else {
                const s = `_${currentTF}`; // _1d, _1w
                c_gex = c[`gex_chg${s}`]; c_oi = c[`oi_chg${s}`]; c_vol = c[`vol_chg${s}`];
                p_gex = p[`gex_chg${s}`]; p_oi = p[`oi_chg${s}`]; p_vol = p[`vol_chg${s}`];
            }

            row.innerHTML = `
                <td class="col-call val-call">${fmt(c_gex, 'gex')}</td>
                <td class="col-call">${fmt(c_oi, 'num')}</td>
                <td class="col-call">${fmt(c_vol, 'num')}</td>
                <td class="col-call">${fmt(c.impliedVolatility, 'iv')}</td>
                <td class="col-strike">${k}</td>
                <td class="col-put">${fmt(p.impliedVolatility, 'iv')}</td>
                <td class="col-put">${fmt(p_vol, 'num')}</td>
                <td class="col-put">${fmt(p_oi, 'num')}</td>
                <td class="col-put val-put">${fmt(p_gex, 'gex')}</td>
            `;
            tbody.appendChild(row);
        });

        if (!priceInserted) {
            const pr = document.createElement('tr'); pr.className = 'current-price-row';
            pr.innerHTML = `<td colspan="9">‚ö° Current Price: $${price.toFixed(2)} ‚ö°</td>`;
            tbody.appendChild(pr);
        }
    }
    init();
</script>
</body>
</html>
