<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OSCC Tactical Dashboard</title>
    <script src="https://cdn.plot.ly/plotly-2.27.0.min.js"></script>
    <style>
        body { background-color: #0f172a; color: #f1f5f9; font-family: 'Segoe UI', sans-serif; padding: 20px; }
        
        /* Ìó§Îçî & Ïª®Ìä∏Î°§ */
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; border-bottom: 1px solid #334155; padding-bottom: 15px; }
        .controls select { background: #1e293b; color: white; border: 1px solid #475569; padding: 10px; border-radius: 8px; font-size: 16px; }

        /* ‚≠ê AI Ïù∏ÏÇ¨Ïù¥Ìä∏ Ïπ¥Îìú (ÌïµÏã¨) ‚≠ê */
        .ai-card { background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%); border: 1px solid #3b82f6; border-radius: 12px; padding: 20px; margin-bottom: 25px; box-shadow: 0 4px 15px rgba(59, 130, 246, 0.2); }
        .ai-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        .ai-sentiment { font-size: 14px; font-weight: bold; padding: 5px 10px; border-radius: 20px; background: #334155; }
        .ai-title { font-size: 20px; font-weight: bold; color: #60a5fa; margin-bottom: 8px; }
        .ai-body { font-size: 15px; line-height: 1.6; color: #cbd5e1; }

        /* Ï∞®Ìä∏ Í∑∏Î¶¨Îìú */
        .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        .chart-box { background: #1e293b; border-radius: 12px; padding: 15px; border: 1px solid #334155; }
        h3 { margin: 0 0 10px 0; color: #94a3b8; font-size: 16px; }

        /* ÌÖåÏù¥Î∏î */
        .table-wrap { margin-top: 20px; overflow-x: auto; }
        table { width: 100%; border-collapse: collapse; font-size: 13px; }
        th, td { padding: 10px; text-align: right; border-bottom: 1px solid #334155; }
        th { background: #0f172a; color: #64748b; text-align: center; }
        .call { color: #4ade80; } .put { color: #f87171; }
    </style>
</head>
<body>

    <div class="header">
        <h1>üöÄ OSCC Tactical Quant</h1>
        <div class="controls">
            <select id="tickerSelect"></select>
        </div>
    </div>

    <div class="ai-card" id="aiSection">
        <div class="ai-header">
            <span style="color: #94a3b8;">ü§ñ AI Strategic Analysis</span>
            <span class="ai-sentiment" id="aiSentiment">Loading...</span>
        </div>
        <div class="ai-title" id="aiTitle">Analyzing Market Regime...</div>
        <div class="ai-body" id="aiBody">Please wait while we load the latest tactical data.</div>
    </div>

    <div class="grid">
        <div class="chart-box">
            <h3>üìä Gamma Exposure (Tactical Flow)</h3>
            <div id="chartGEX" style="height: 350px;"></div>
        </div>
        <div class="chart-box">
            <h3>üß± Open Interest (Walls)</h3>
            <div id="chartOI" style="height: 350px;"></div>
        </div>
    </div>

    <div class="chart-box table-wrap">
        <h3>üìã Effective Option Chain</h3>
        <table id="optTable">
            <thead><tr><th>Type</th><th>Strike</th><th>GEX ($)</th><th>OI</th><th>Vol</th><th>IV</th></tr></thead>
            <tbody></tbody>
        </table>
    </div>

    <script>
        let gexData = [];
        let aiData = {};

        async function init() {
            try {
                // Îç∞Ïù¥ÌÑ∞ Î°úÎìú
                const [resGex, resAi] = await Promise.all([
                    fetch('dashboard_gex_details.json'),
                    fetch('dashboard_ai.json')
                ]);
                gexData = await resGex.json();
                aiData = await resAi.json();

                // Ï¢ÖÎ™© ÏÑ∏ÌåÖ
                const tickers = [...new Set(gexData.map(d => d.ticker))].sort();
                const sel = document.getElementById('tickerSelect');
                tickers.forEach(t => {
                    let opt = document.createElement('option');
                    opt.value = t; opt.text = `$${t}`;
                    sel.appendChild(opt);
                });

                sel.addEventListener('change', render);
                if(tickers.length > 0) render();

            } catch(e) { console.error(e); }
        }

        function render() {
            const ticker = document.getElementById('tickerSelect').value;
            
            // 1. AI ÏΩîÎ©òÌä∏ ÏóÖÎç∞Ïù¥Ìä∏
            const ai = aiData[ticker];
            if (ai) {
                document.getElementById('aiSentiment').innerText = ai.sentiment;
                document.getElementById('aiSentiment').style.color = ai.sentiment.includes('Bear') ? '#f87171' : '#4ade80';
                document.getElementById('aiTitle').innerText = ai.title;
                document.getElementById('aiBody').innerText = ai.body;
            } else {
                document.getElementById('aiTitle').innerText = "No Insight Available";
            }

            // 2. Îç∞Ïù¥ÌÑ∞ ÌïÑÌÑ∞ÎßÅ
            const data = gexData.filter(d => d.ticker === ticker).sort((a,b) => a.strike - b.strike);
            const expiry = data[0]?.expiry || "Unknown";
            document.querySelector('h1').innerText = `üöÄ OSCC Tactical Quant (Target: ${expiry})`;

            // 3. Ï∞®Ìä∏ Í∑∏Î¶¨Í∏∞
            drawChart('chartGEX', data, 'gex_notional', 'Net Gamma');
            drawChart('chartOI', data, 'openInterest', 'Open Interest');
            drawTable(data);
        }

        function drawChart(id, data, key, label) {
            const calls = data.filter(d => d.type === 'call');
            const puts = data.filter(d => d.type === 'put');
            
            // GEXÎäî PutÏùÑ ÏùåÏàòÎ°ú, OIÎäî ÏñëÏàòÎ°ú ÌëúÌòÑ (ÎπÑÍµê Ïö©Ïù¥ÏÑ±)
            const yPuts = key === 'gex_notional' ? puts.map(d => d[key]) : puts.map(d => -d[key]);

            Plotly.newPlot(id, [
                {x: calls.map(d=>d.strike), y: calls.map(d=>d[key]), type: 'bar', name: 'Call', marker:{color:'#4ade80'}},
                {x: puts.map(d=>d.strike), y: yPuts, type: 'bar', name: 'Put', marker:{color:'#f87171'}}
            ], {
                barmode: 'relative', paper_bgcolor: 'rgba(0,0,0,0)', plot_bgcolor: 'rgba(0,0,0,0)',
                font: {color: '#94a3b8'}, margin: {t:20, b:30, l:40, r:20},
                xaxis: {gridcolor: '#334155'}, yaxis: {gridcolor: '#334155'}
            }, {responsive: true});
        }

        function drawTable(data) {
            const tbody = document.querySelector('#optTable tbody');
            tbody.innerHTML = '';
            data.forEach(d => {
                let tr = document.createElement('tr');
                tr.innerHTML = `
                    <td class="${d.type}">${d.type.toUpperCase()}</td>
                    <td><b>${d.strike}</b></td>
                    <td style="color:${d.gex_notional>0?'#4ade80':'#f87171'}">${Math.round(d.gex_notional).toLocaleString()}</td>
                    <td>${d.openInterest.toLocaleString()}</td>
                    <td>${d.volume.toLocaleString()}</td>
                    <td>${(d.impliedVolatility*100).toFixed(1)}%</td>
                `;
                tbody.appendChild(tr);
            });
        }

        init();
    </script>
</body>
</html>
