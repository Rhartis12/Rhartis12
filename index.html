<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OSCC Pro Analyst Deck</title>
    <script src="https://cdn.plot.ly/plotly-2.27.0.min.js"></script>
    <style>
        /* --- ê¸°ë³¸ í…Œë§ˆ --- */
        :root { --bg: #0f172a; --card: #1e293b; --text: #f1f5f9; --subtext: #94a3b8; --border: #334155; --call: #10b981; --put: #ef4444; --accent: #3b82f6; }
        body { background-color: var(--bg); color: var(--text); font-family: 'Segoe UI', Roboto, Helvetica, sans-serif; margin: 0; padding: 0; }
        
        /* --- ë ˆì´ì•„ì›ƒ --- */
        .container { max-width: 1200px; margin: 0 auto; padding: 20px; }
        
        /* í—¤ë” */
        header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; border-bottom: 1px solid var(--border); padding-bottom: 15px; }
        h1 { margin: 0; font-size: 24px; background: linear-gradient(90deg, #60a5fa, #a78bfa); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        select#tickerSelect { background: var(--card); color: white; border: 1px solid var(--border); padding: 8px 16px; border-radius: 6px; font-size: 16px; outline: none; }

        /* --- ë¦¬ë³¸ ë©”ë‰´ (ë§Œê¸°ì¼ ì„ íƒ) --- */
        .ribbon-container { overflow-x: auto; white-space: nowrap; padding-bottom: 10px; margin-bottom: 20px; -webkit-overflow-scrolling: touch; }
        .ribbon-btn {
            display: inline-block; background: var(--card); color: var(--subtext); border: 1px solid var(--border);
            padding: 8px 16px; margin-right: 8px; border-radius: 20px; cursor: pointer; font-size: 14px; transition: all 0.2s;
        }
        .ribbon-btn:hover { border-color: var(--accent); color: white; }
        .ribbon-btn.active { background: var(--accent); color: white; border-color: var(--accent); font-weight: bold; box-shadow: 0 0 10px rgba(59, 130, 246, 0.5); }
        .ribbon-container::-webkit-scrollbar { height: 6px; }
        .ribbon-container::-webkit-scrollbar-thumb { background: var(--border); border-radius: 3px; }

        /* --- AI ì¸ì‚¬ì´íŠ¸ ì¹´ë“œ --- */
        .ai-card { background: linear-gradient(180deg, rgba(30,41,59,0.8) 0%, rgba(15,23,42,1) 100%); border: 1px solid var(--border); border-left: 4px solid var(--accent); border-radius: 12px; padding: 20px; margin-bottom: 30px; }
        .ai-title { font-size: 18px; font-weight: bold; color: var(--accent); margin-bottom: 10px; display: flex; align-items: center; gap: 10px; }
        .ai-body { font-size: 15px; line-height: 1.6; color: #cbd5e1; white-space: pre-line; }
        .badge { font-size: 12px; padding: 4px 8px; border-radius: 4px; background: #334155; color: white; }

        /* --- ì°¨íŠ¸ (ìˆ˜ì§ ë°°ì¹˜) --- */
        .chart-section { margin-bottom: 40px; }
        .chart-box { background: var(--card); border: 1px solid var(--border); border-radius: 12px; padding: 15px; margin-bottom: 20px; height: 400px; position: relative; }
        .chart-title { position: absolute; top: 15px; left: 20px; font-weight: bold; color: var(--subtext); z-index: 10; pointer-events: none; }

        /* --- ì˜µì…˜ ì²´ì¸ í…Œì´ë¸” (Call - Strike - Put) --- */
        .table-section { background: var(--card); border: 1px solid var(--border); border-radius: 12px; overflow: hidden; }
        .table-header { padding: 15px 20px; font-weight: bold; border-bottom: 1px solid var(--border); background: #253347; display: flex; justify-content: space-between; }
        
        .table-scroll { overflow-x: auto; max-height: 800px; }
        table { width: 100%; border-collapse: collapse; font-size: 13px; min-width: 800px; }
        
        th { background: #0f172a; color: var(--subtext); padding: 12px 8px; font-weight: 600; position: sticky; top: 0; z-index: 5; text-transform: uppercase; font-size: 11px; letter-spacing: 0.5px; }
        /* ê·¸ë£¹ í—¤ë” */
        th.group-call { border-bottom: 2px solid var(--call); color: var(--call); }
        th.group-put { border-bottom: 2px solid var(--put); color: var(--put); }
        th.group-strike { border-bottom: 2px solid #fff; color: white; background: #1e293b; }

        td { padding: 8px 8px; border-bottom: 1px solid #334155; white-space: nowrap; }
        tr:hover { background-color: #334155; }

        /* ë°ì´í„° ì •ë ¬ ë° ìƒ‰ìƒ */
        .col-call { text-align: right; color: #cbd5e1; }
        .col-put { text-align: left; color: #cbd5e1; }
        .col-strike { text-align: center; font-weight: bold; font-size: 14px; background: #253347; color: white; width: 80px; }
        
        .val-call { color: var(--call); }
        .val-put { color: var(--put); }
        .atm-row { background-color: rgba(255, 255, 255, 0.05); border-left: 2px solid yellow; border-right: 2px solid yellow; }
        
        /* ìœ í‹¸ë¦¬í‹° */
        .loading { text-align: center; padding: 50px; color: var(--subtext); }
        .positive { color: var(--call); } .negative { color: var(--put); }
    </style>
</head>
<body>

<div class="container">
    <header>
        <h1>ğŸš€ OSCC Alpha Deck</h1>
        <select id="tickerSelect"></select>
    </header>

    <div id="ribbonMenu" class="ribbon-container">
        </div>

    <div class="ai-card" id="aiSection">
        <div class="ai-title">
            <span>ğŸ¤– AI Tactical Insight</span>
            <span class="badge" id="aiExpiryBadge">Target: --</span>
        </div>
        <div class="ai-body" id="aiBody">Loading strategy...</div>
    </div>

    <div class="chart-section">
        <div class="chart-box">
            <div class="chart-title">ğŸ“Š Net Gamma Exposure (Market Maker Positioning)</div>
            <div id="chartGEX" style="width:100%; height:100%;"></div>
        </div>
        <div class="chart-box">
            <div class="chart-title">ğŸ§± Open Interest Walls (Support / Resistance)</div>
            <div id="chartOI" style="width:100%; height:100%;"></div>
        </div>
    </div>

    <div class="table-section">
        <div class="table-header">
            <span>ğŸ“‹ Option Chain Details</span>
            <span style="font-size: 12px; color: #94a3b8;">*Highlighted row is nearest to current price (ATM)</span>
        </div>
        <div class="table-scroll">
            <table id="chainTable">
                <thead>
                    <tr>
                        <th class="group-call">GEX ($)</th>
                        <th class="group-call">OI</th>
                        <th class="group-call">Vol</th>
                        <th class="group-call">IV</th>
                        <th class="group-call">Bid/Ask</th>
                        
                        <th class="group-strike">STRIKE</th>
                        
                        <th class="group-put">Bid/Ask</th>
                        <th class="group-put">IV</th>
                        <th class="group-put">Vol</th>
                        <th class="group-put">OI</th>
                        <th class="group-put">GEX ($)</th>
                    </tr>
                </thead>
                <tbody>
                    </tbody>
            </table>
        </div>
    </div>
</div>

<script>
    let rawData = [];
    let aiData = {};

    async function init() {
        try {
            // ë°ì´í„° ë³‘ë ¬ ë¡œë“œ
            const [resGex, resAi] = await Promise.all([
                fetch('dashboard_gex_details.json'),
                fetch('dashboard_ai.json')
            ]);
            rawData = await resGex.json();
            aiData = await resAi.json();

            // ì¢…ëª© ëª©ë¡ ìƒì„±
            const tickers = [...new Set(rawData.map(d => d.ticker))].sort();
            const sel = document.getElementById('tickerSelect');
            tickers.forEach(t => {
                let opt = document.createElement('option');
                opt.value = t; opt.text = `$${t}`;
                sel.appendChild(opt);
            });

            sel.addEventListener('change', () => updateRibbon(true));

            if(tickers.length > 0) updateRibbon(true); // ì´ˆê¸° ì‹¤í–‰

        } catch(e) { console.error("Init Error:", e); document.body.innerHTML = "<h2 style='text-align:center; color:white'>Data Load Failed. Check JSON files.</h2>"; }
    }

    // ì¢…ëª© ë³€ê²½ ì‹œ ë¦¬ë³¸ ë©”ë‰´ ì—…ë°ì´íŠ¸
    function updateRibbon(resetToFirst = false) {
        const ticker = document.getElementById('tickerSelect').value;
        const ribbon = document.getElementById('ribbonMenu');
        ribbon.innerHTML = '';

        // í•´ë‹¹ ì¢…ëª©ì˜ ëª¨ë“  ë§Œê¸°ì¼ ì¶”ì¶œ
        const expiries = [...new Set(rawData.filter(d => d.ticker === ticker).map(d => d.expiry))].sort();

        expiries.forEach((date, idx) => {
            const btn = document.createElement('div');
            btn.className = 'ribbon-btn';
            btn.innerText = date;
            btn.onclick = () => {
                // í™œì„± ìƒíƒœ ë³€ê²½
                document.querySelectorAll('.ribbon-btn').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                renderDashboard(ticker, date);
            };
            ribbon.appendChild(btn);

            // ê¸°ë³¸ê°’: ì²« ë²ˆì§¸ ë§Œê¸°ì¼ (í˜¹ì€ AIê°€ ë¶„ì„í•œ íƒ€ê²Ÿ ë§Œê¸°ì¼ë¡œ ì„¤ì • ê°€ëŠ¥)
            if (resetToFirst && idx === 0) btn.click();
        });
    }

    // ëŒ€ì‹œë³´ë“œ ë Œë”ë§ (ì°¨íŠ¸ + í…Œì´ë¸” + AI)
    function renderDashboard(ticker, expiry) {
        // 1. AI ì½”ë©˜íŠ¸ í‘œì‹œ
        const aiInfo = aiData[ticker];
        if (aiInfo) {
            document.getElementById('aiExpiryBadge').innerText = `AI Target: ${aiInfo.expiry}`;
            document.getElementById('aiBody').innerHTML = `<strong>[${aiInfo.sentiment}] ${aiInfo.title}</strong>\n\n${aiInfo.body}`;
        } else {
            document.getElementById('aiBody').innerText = "No AI analysis available for this ticker yet.";
        }

        // 2. ë°ì´í„° í•„í„°ë§
        const data = rawData.filter(d => d.ticker === ticker && d.expiry === expiry);
        
        // í˜„ì¬ê°€ ì¶”ì • (ATM ì°¾ê¸°ìš©) - ë°ì´í„°ì— price í•„ë“œê°€ ì—†ìœ¼ë¯€ë¡œ, GEXê°€ ê°€ì¥ í° ê·¼ì²˜ë‚˜ ë³„ë„ ë¡œì§ í•„ìš”.
        // ì—¬ê¸°ì„œëŠ” ë°ì´í„° ë¡œë“œ ì‹œ AI jsonì— ìˆëŠ” priceë¥¼ ì°¸ì¡°
        const currentPrice = aiInfo ? aiInfo.price : 0;

        // 3. ì°¨íŠ¸ ê·¸ë¦¬ê¸°
        drawCharts(data);

        // 4. í…Œì´ë¸” ê·¸ë¦¬ê¸° (Strike ê¸°ì¤€ìœ¼ë¡œ Grouping)
        drawOptionChain(data, currentPrice);
    }

    function drawCharts(data) {
        const sorted = [...data].sort((a,b) => a.strike - b.strike);
        const calls = sorted.filter(d => d.type === 'call');
        const puts = sorted.filter(d => d.type === 'put');

        const layoutBase = {
            barmode: 'relative', paper_bgcolor: 'rgba(0,0,0,0)', plot_bgcolor: 'rgba(0,0,0,0)',
            font: {color: '#94a3b8'}, margin: {t:40, b:30, l:50, r:20},
            xaxis: {gridcolor: '#334155'}, yaxis: {gridcolor: '#334155', zerolinecolor: '#fff'}
        };

        // GEX Chart
        Plotly.newPlot('chartGEX', [
            { x: calls.map(d=>d.strike), y: calls.map(d=>d.gex_notional), type: 'bar', name: 'Call GEX', marker:{color:'#10b981'} },
            { x: puts.map(d=>d.strike), y: puts.map(d=>-d.gex_notional), type: 'bar', name: 'Put GEX', marker:{color:'#ef4444'} } // Put ìŒìˆ˜ í‘œí˜„
        ], layoutBase, {responsive: true, displayModeBar: false});

        // OI Chart
        Plotly.newPlot('chartOI', [
            { x: calls.map(d=>d.strike), y: calls.map(d=>d.openInterest), type: 'bar', name: 'Call OI', marker:{color:'#059669', opacity:0.7} },
            { x: puts.map(d=>d.strike), y: puts.map(d=>d.openInterest), type: 'bar', name: 'Put OI', marker:{color:'#dc2626', opacity:0.7} } // Put ì–‘ìˆ˜ í‘œí˜„ (ë²½ ë¹„êµ)
        ], layoutBase, {responsive: true, displayModeBar: false});
    }

    function drawOptionChain(data, currentPrice) {
        const tbody = document.querySelector('#chainTable tbody');
        tbody.innerHTML = '';

        // Strike ë³„ë¡œ ë°ì´í„° ë¬¶ê¸°
        const strikeMap = {};
        data.forEach(d => {
            if(!strikeMap[d.strike]) strikeMap[d.strike] = {call: null, put: null};
            strikeMap[d.strike][d.type] = d;
        });

        // Strike ì •ë ¬
        const strikes = Object.keys(strikeMap).map(Number).sort((a,b) => a - b);

        // ATM ì°¾ê¸° (ê°€ì¥ ê°€ê¹Œìš´ Strike)
        let closestStrike = strikes[0];
        let minDiff = Math.abs(currentPrice - closestStrike);
        strikes.forEach(k => {
            const diff = Math.abs(currentPrice - k);
            if(diff < minDiff) { minDiff = diff; closestStrike = k; }
        });

        // í¬ë§·í„°
        const num = (n) => n ? n.toLocaleString() : '-';
        const gex = (n) => n ? (n/1000).toFixed(0) + 'k' : '-'; // Kë‹¨ìœ„ ì¶•ì•½
        const iv = (n) => n ? (n*100).toFixed(1) + '%' : '-';

        strikes.forEach(k => {
            const row = document.createElement('tr');
            if(k === closestStrike) row.className = 'atm-row';

            const c = strikeMap[k].call || {};
            const p = strikeMap[k].put || {};

            // ë°ì´í„°ê°€ ë¹„ì–´ìˆì„ ìˆ˜ ìˆìŒ
            row.innerHTML = `
                <td class="col-call val-call">${gex(c.gex_notional)}</td>
                <td class="col-call">${num(c.openInterest)}</td>
                <td class="col-call">${num(c.volume)}</td>
                <td class="col-call">${iv(c.impliedVolatility)}</td>
                <td class="col-call" style="font-size:11px; color:#64748b;">-</td> 
                
                <td class="col-strike">${k}</td>
                
                <td class="col-put" style="font-size:11px; color:#64748b;">-</td>
                <td class="col-put">${iv(p.impliedVolatility)}</td>
                <td class="col-put">${num(p.volume)}</td>
                <td class="col-put">${num(p.openInterest)}</td>
                <td class="col-put val-put">${gex(p.gex_notional)}</td>
            `;
            tbody.appendChild(row);
        });
    }

    init();
</script>

</body>
</html>
