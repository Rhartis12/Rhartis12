<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OSCC Alpha Deck</title>
    <script src="https://cdn.plot.ly/plotly-2.27.0.min.js"></script>
    <style>
        /* --- ÌÖåÎßà ÏÑ§Ï†ï --- */
        :root { --bg: #0f172a; --card: #1e293b; --text: #f1f5f9; --subtext: #94a3b8; --border: #334155; --call: #10b981; --put: #ef4444; --accent: #3b82f6; }
        body { background-color: var(--bg); color: var(--text); font-family: 'Segoe UI', Roboto, Helvetica, sans-serif; margin: 0; padding: 0; }
        .container { max-width: 1200px; margin: 0 auto; padding: 20px; }
        
        /* Ìó§Îçî & Î¶¨Î≥∏ */
        header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; border-bottom: 1px solid var(--border); padding-bottom: 15px; }
        h1 { margin: 0; font-size: 24px; background: linear-gradient(90deg, #60a5fa, #a78bfa); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        select#tickerSelect { background: var(--card); color: white; border: 1px solid var(--border); padding: 8px 16px; border-radius: 6px; outline: none; }
        
        .ribbon-container { overflow-x: auto; white-space: nowrap; padding-bottom: 10px; margin-bottom: 20px; }
        .ribbon-btn { display: inline-block; background: var(--card); color: var(--subtext); border: 1px solid var(--border); padding: 8px 16px; margin-right: 8px; border-radius: 20px; cursor: pointer; font-size: 14px; transition: all 0.2s; }
        .ribbon-btn:hover { border-color: var(--accent); color: white; }
        .ribbon-btn.active { background: var(--accent); color: white; border-color: var(--accent); font-weight: bold; box-shadow: 0 0 10px rgba(59, 130, 246, 0.3); }

        /* AI Ïπ¥Îìú */
        .ai-card { background: linear-gradient(180deg, rgba(30,41,59,0.9) 0%, rgba(15,23,42,1) 100%); border: 1px solid var(--border); border-left: 4px solid var(--accent); border-radius: 12px; padding: 25px; margin-bottom: 30px; box-shadow: 0 4px 20px rgba(0,0,0,0.4); }
        .ai-title { font-size: 20px; font-weight: bold; color: var(--accent); margin-bottom: 15px; display: flex; align-items: center; gap: 10px; }
        .ai-body { font-size: 16px; line-height: 1.7; color: #cbd5e1; white-space: pre-line; } /* ÏÉÅÏÑ∏ ÎÇ¥Ïö©ÏùÑ ÏúÑÌï¥ Ìè∞Ìä∏ ÌÇ§ÏõÄ */
        .badge { font-size: 12px; padding: 4px 8px; border-radius: 4px; background: #334155; color: white; margin-left: auto; }

        /* Ï∞®Ìä∏ */
        .chart-box { background: var(--card); border: 1px solid var(--border); border-radius: 12px; padding: 15px; margin-bottom: 20px; height: 500px; position: relative; }
        .chart-title { position: absolute; top: 15px; left: 20px; font-weight: bold; color: var(--subtext); z-index: 10; pointer-events: none; }

        /* ÌÖåÏù¥Î∏î */
        .table-section { background: var(--card); border: 1px solid var(--border); border-radius: 12px; overflow: hidden; }
        .table-header { padding: 15px 20px; font-weight: bold; border-bottom: 1px solid var(--border); background: #253347; display: flex; justify-content: space-between; align-items: center; }
        
        /* ÌÉÄÏûÑÌîÑÎ†àÏûÑ Ïä§ÏúÑÏπò */
        .tf-group { display: flex; background: #0f172a; border-radius: 6px; padding: 2px; border: 1px solid var(--border); }
        .tf-btn { background: transparent; color: var(--subtext); border: none; padding: 6px 12px; cursor: pointer; border-radius: 4px; font-size: 12px; font-weight: 600; }
        .tf-btn.active { background: var(--accent); color: white; }

        .table-scroll { overflow-x: auto; max-height: 600px; scroll-behavior: smooth; } /* Ïä§ÌÅ¨Î°§ ÎÜíÏù¥ Ï°∞Ï†ï */
        table { width: 100%; border-collapse: collapse; font-size: 13px; min-width: 900px; }
        th { background: #0f172a; color: var(--subtext); padding: 12px 8px; font-weight: 600; position: sticky; top: 0; z-index: 5; text-align: center; }
        
        th.group-call { border-bottom: 2px solid var(--call); color: var(--call); }
        th.group-put { border-bottom: 2px solid var(--put); color: var(--put); }
        th.group-strike { border-bottom: 2px solid #fff; color: white; background: #1e293b; }
        
        td { padding: 8px 8px; border-bottom: 1px solid #334155; white-space: nowrap; }
        .col-call { text-align: right; color: #cbd5e1; } .col-put { text-align: left; color: #cbd5e1; }
        .col-strike { text-align: center; font-weight: bold; background: #253347; color: white; width: 80px; }
        
        /* Î≥ÄÌôîÎüâ ÏÉâÏÉÅ */
        .diff-pos { color: var(--call); font-weight: bold; }
        .diff-neg { color: var(--put); font-weight: bold; }
        .diff-neu { color: #64748b; }

        /* ÌòÑÏû¨Í∞Ä Ìñâ (Ïä§ÌÅ¨Î°§ ÌÉÄÍ≤ü) */
        .current-price-row td { background-color: rgba(255, 215, 0, 0.15); color: #ffd700; font-weight: bold; text-align: center; border-top: 1px dashed #ffd700; border-bottom: 1px dashed #ffd700; padding: 10px 0; font-size: 14px; }
        .atm-row { background-color: rgba(255, 255, 255, 0.05); }
    </style>
</head>
<body>

<div class="container">
    <header>
        <h1>üöÄ OSCC Alpha Deck</h1>
        <select id="tickerSelect"></select>
    </header>

    <div id="ribbonMenu" class="ribbon-container"></div>

    <div class="ai-card" id="aiSection">
        <div class="ai-title">
            <span>ü§ñ AI Tactical Insight</span>
            <span class="badge" id="aiExpiryBadge">Target: --</span>
        </div>
        <div class="ai-body" id="aiBody">Loading detailed analysis...</div>
    </div>

    <div class="chart-box">
        <div class="chart-title">üìä Net Gamma Exposure (GEX Map)</div>
        <div id="chartGEX" style="width:100%; height:100%;"></div>
    </div>
    <div class="chart-box">
        <div class="chart-title">üß± Open Interest Walls (OI)</div>
        <div id="chartOI" style="width:100%; height:100%;"></div>
    </div>

    <div class="table-section">
        <div class="table-header">
            <span>üìã Option Chain Details</span>
            <div class="tf-group">
                <button class="tf-btn active" onclick="setTF('curr', this)">Current</button>
                <button class="tf-btn" onclick="setTF('1d', this)">1D Œî</button>
                <button class="tf-btn" onclick="setTF('1w', this)">1W Œî</button>
            </div>
        </div>
        <div class="table-scroll" id="tableScrollArea">
            <table id="chainTable">
                <thead>
                    <tr>
                        <th class="group-call">GEX</th><th class="group-call">OI</th><th class="group-call">Vol</th><th class="group-call">IV</th>
                        <th class="group-strike">STRIKE</th>
                        <th class="group-put">IV</th><th class="group-put">Vol</th><th class="group-put">OI</th><th class="group-put">GEX</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>
    </div>
</div>

<script>
    let rawData = [], aiData = {}, summaryData = [];
    let currentTF = 'curr'; 
    let currentTicker = '', currentExpiry = '';

    async function init() {
        try {
            const [resGex, resAi, resSum] = await Promise.all([
                fetch('dashboard_gex_details.json'), 
                fetch('dashboard_ai.json'),
                fetch('dashboard_summary.json')
            ]);
            rawData = await resGex.json(); 
            aiData = await resAi.json();
            summaryData = await resSum.json();

            const tickers = [...new Set(rawData.map(d => d.ticker))].sort();
            const sel = document.getElementById('tickerSelect');
            tickers.forEach(t => { let opt = document.createElement('option'); opt.value = t; opt.text = `$${t}`; sel.appendChild(opt); });
            
            sel.addEventListener('change', () => updateRibbon(true));
            if(tickers.length > 0) updateRibbon(true); // Ï¥àÍ∏∞ Ïã§Ìñâ

        } catch(e) { console.error(e); }
    }

    function updateRibbon(reset) {
        currentTicker = document.getElementById('tickerSelect').value;
        const ribbon = document.getElementById('ribbonMenu');
        ribbon.innerHTML = '';
        
        // Îç∞Ïù¥ÌÑ∞Ïóê ÏûàÎäî ÎßåÍ∏∞Ïùº Î™©Î°ù
        const expiries = [...new Set(rawData.filter(d => d.ticker === currentTicker).map(d => d.expiry))].sort();
        
        // AIÍ∞Ä Î∂ÑÏÑùÌïú ÌÉÄÍ≤ü ÎßåÍ∏∞Ïùº Ï∞æÍ∏∞
        const aiTargetDate = aiData[currentTicker] ? aiData[currentTicker].expiry : null;

        expiries.forEach((date, idx) => {
            const btn = document.createElement('div');
            btn.className = 'ribbon-btn'; 
            btn.innerText = date;
            
            // ‚≠ê [ÌïµÏã¨] AI ÌÉÄÍ≤ü ÎÇ†ÏßúÎ©¥ 'monthly-target' ÌÅ¥ÎûòÏä§ Î∂ÄÏó¨ (ÎÇòÏ§ëÏóê Ï∞æÍ∏∞ ÏâΩÍ≤å)
            if (date === aiTargetDate) btn.dataset.isTarget = "true";

            btn.onclick = () => { 
                document.querySelectorAll('.ribbon-btn').forEach(b=>b.classList.remove('active')); 
                btn.classList.add('active'); 
                currentExpiry = date;
                renderDashboard(); 
            };
            ribbon.appendChild(btn);
        });

        if (reset) {
            // ‚≠ê [ÌïµÏã¨] Î¶¨ÏÖã Ïãú: AI ÌÉÄÍ≤ü ÎÇ†Ïßú Î≤ÑÌäºÏù¥ ÏûàÏúºÎ©¥ ÌÅ¥Î¶≠, ÏóÜÏúºÎ©¥ Ï≤´ Î≤àÏß∏ ÌÅ¥Î¶≠
            const targetBtn = ribbon.querySelector('[data-is-target="true"]');
            if (targetBtn) targetBtn.click();
            else if (ribbon.firstChild) ribbon.firstChild.click();
        }
    }

    function setTF(tf, btn) {
        currentTF = tf;
        document.querySelectorAll('.tf-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        renderDashboard(true);
    }

    function renderDashboard(tableOnly = false) {
        // Í∞ÄÍ≤© Ï∞æÍ∏∞
        let price = 0;
        const sumInfo = summaryData.filter(d => d.ticker === currentTicker).pop();
        if(sumInfo) price = sumInfo.price;
        else if(aiData[currentTicker]) price = aiData[currentTicker].price;

        const data = rawData.filter(d => d.ticker === currentTicker && d.expiry === currentExpiry);
        if(price === 0 && data.length > 0) price = data[0].strike; 

        if(!tableOnly) {
            updateAI(price);
            drawCharts(data, price);
        }
        drawTable(data, price);
    }

    function updateAI(price) {
        const info = aiData[currentTicker];
        if (info) {
            document.getElementById('aiExpiryBadge').innerText = `Target: ${info.expiry || 'N/A'}`;
            // ÏÉÅÏÑ∏ ÎÇ¥Ïö© ÌëúÏãú
            document.getElementById('aiBody').innerHTML = `<strong>[${info.sentiment}] ${info.title}</strong>\n\n${info.body}`;
        } else {
            document.getElementById('aiBody').innerText = "AI Analysis not available.";
        }
    }

    function drawCharts(data, price) {
        const strikeMap = new Map();
        data.forEach(d => strikeMap.set(d.strike, (strikeMap.get(d.strike)||0) + Math.abs(d.gex_notional)));
        const topStrikes = Array.from(strikeMap.entries()).sort((a,b)=>b[1]-a[1]).slice(0,40).map(e=>e[0]);
        const filtered = data.filter(d => topStrikes.includes(d.strike));

        const calls = filtered.filter(d => d.type === 'call').sort((a,b) => a.strike - b.strike);
        const puts = filtered.filter(d => d.type === 'put').sort((a,b) => a.strike - b.strike);

        const layout = {
            barmode: 'relative', paper_bgcolor: 'rgba(0,0,0,0)', plot_bgcolor: 'rgba(0,0,0,0)',
            font: {color: '#94a3b8'}, margin: {t:40, b:30, l:60, r:20},
            xaxis: {gridcolor: '#334155', zerolinecolor: '#fff'},
            yaxis: {gridcolor: '#334155', tickformat: '.1f'},
            shapes: price > 0 ? [{type:'line', x0:0, x1:1, xref:'paper', y0:price, y1:price, yref:'y', line:{color:'#ffd700', width:2, dash:'dot'}}] : []
        };

        Plotly.newPlot('chartGEX', [
            { x: puts.map(d=>d.gex_notional), y: puts.map(d=>d.strike), type: 'bar', orientation: 'h', name: 'Put', marker:{color:'#ef4444'} },
            { x: calls.map(d=>d.gex_notional), y: calls.map(d=>d.strike), type: 'bar', orientation: 'h', name: 'Call', marker:{color:'#10b981'} }
        ], {...layout, xaxis:{...layout.xaxis, title:'Net Gamma ($)'}}, {responsive:true, displayModeBar:false});

        Plotly.newPlot('chartOI', [
            { x: puts.map(d=>d.openInterest), y: puts.map(d=>d.strike), type: 'bar', orientation: 'h', name: 'Put', marker:{color:'#dc2626', opacity:0.7} },
            { x: calls.map(d=>d.openInterest), y: calls.map(d=>d.strike), type: 'bar', orientation: 'h', name: 'Call', marker:{color:'#059669', opacity:0.7} }
        ], {...layout, xaxis:{...layout.xaxis, title:'Open Interest'}}, {responsive:true, displayModeBar:false});
    }

    function drawTable(data, price) {
        const tbody = document.querySelector('#chainTable tbody'); tbody.innerHTML = '';
        const strikeMap = {};
        data.forEach(d => { if(!strikeMap[d.strike]) strikeMap[d.strike] = {call:{}, put:{}}; strikeMap[d.strike][d.type] = d; });
        const strikes = Object.keys(strikeMap).map(Number).sort((a,b) => a - b);
        
        let closest = strikes[0], minDiff = Math.abs(price - closest);
        strikes.forEach(k => { const diff = Math.abs(price - k); if(diff < minDiff) { minDiff = diff; closest = k; } });

        const fmt = (val, type) => {
            if(val === undefined || val === null) return '-';
            if(currentTF === 'curr') {
                if(type === 'gex') return (val/1000).toFixed(0) + 'k';
                if(type === 'iv') return (val*100).toFixed(1) + '%';
                return val.toLocaleString();
            }
            if(val === 0) return '<span class="diff-neu">-</span>';
            const sign = val > 0 ? '+' : '';
            const cls = val > 0 ? 'diff-pos' : 'diff-neg';
            if(type === 'gex') return `<span class="${cls}">${sign}${(val/1000).toFixed(0)}k</span>`;
            if(type === 'iv') return `<span class="diff-neu">-</span>`; 
            return `<span class="${cls}">${sign}${val.toLocaleString()}</span>`;
        };

        let priceInserted = false;
        let targetRow = null; // ‚≠ê Ïä§ÌÅ¨Î°§ ÌÉÄÍ≤ü ÏöîÏÜå

        const appendRow = (html, isTarget) => {
            const tr = document.createElement('tr');
            if(isTarget) { tr.className = 'current-price-row'; targetRow = tr; }
            tr.innerHTML = html;
            tbody.appendChild(tr);
        }

        strikes.forEach(k => {
            if (!priceInserted && price < k) {
                appendRow(`<td colspan="9">‚ö° Current Price: $${price.toFixed(2)} ‚ö°</td>`, true);
                priceInserted = true;
            }

            const c = strikeMap[k].call, p = strikeMap[k].put;
            let c_gex, c_oi, c_vol, p_gex, p_oi, p_vol;
            if(currentTF === 'curr') {
                c_gex = c.gex_notional; c_oi = c.openInterest; c_vol = c.volume;
                p_gex = p.gex_notional; p_oi = p.openInterest; p_vol = p.volume;
            } else {
                const s = `_${currentTF}`;
                c_gex = c[`gex_chg${s}`]; c_oi = c[`oi_chg${s}`]; c_vol = c[`vol_chg${s}`];
                p_gex = p[`gex_chg${s}`]; p_oi = p[`oi_chg${s}`]; p_vol = p[`vol_chg${s}`];
            }

            const tr = document.createElement('tr');
            if(k === closest) tr.className = 'atm-row';
            tr.innerHTML = `
                <td class="col-call val-call">${fmt(c_gex, 'gex')}</td><td class="col-call">${fmt(c_oi, 'num')}</td><td class="col-call">${fmt(c_vol, 'num')}</td><td class="col-call">${fmt(c.impliedVolatility, 'iv')}</td>
                <td class="col-strike">${k}</td>
                <td class="col-put">${fmt(p.impliedVolatility, 'iv')}</td><td class="col-put">${fmt(p_vol, 'num')}</td><td class="col-put">${fmt(p_oi, 'num')}</td><td class="col-put val-put">${fmt(p_gex, 'gex')}</td>`;
            tbody.appendChild(tr);
        });

        if (!priceInserted) {
            appendRow(`<td colspan="9">‚ö° Current Price: $${price.toFixed(2)} ‚ö°</td>`, true);
        }

        // ‚≠ê [ÌïµÏã¨] ÏûêÎèô Ïä§ÌÅ¨Î°§ Î°úÏßÅ (ÌÖåÏù¥Î∏î Î†åÎçîÎßÅ ÌõÑ Ïã§Ìñâ)
        if (targetRow) {
            setTimeout(() => {
                targetRow.scrollIntoView({ behavior: 'smooth', block: 'center' });
            }, 100);
        }
    }
    init();
</script>
</body>
</html>
