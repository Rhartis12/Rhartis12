<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OSCC Command Center</title>
    <script src="https://cdn.plot.ly/plotly-2.27.0.min.js"></script>
    <style>
        body { background-color: #0f172a; color: #e2e8f0; font-family: 'Inter', sans-serif; margin: 0; padding: 20px; }
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; border-bottom: 1px solid #334155; padding-bottom: 10px; }
        .controls { display: flex; gap: 15px; }
        select { background: #1e293b; color: #fff; border: 1px solid #475569; padding: 8px 16px; border-radius: 6px; font-size: 14px; }
        
        /* ê·¸ë¦¬ë“œ ë ˆì´ì•„ì›ƒ: 3ê°œì˜ ì°¨íŠ¸ ë°°ì¹˜ */
        .dashboard-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px; }
        .full-width { grid-column: 1 / -1; } /* 3ë²ˆ ì°¨íŠ¸ëŠ” ë„“ê²Œ */
        
        .card { background: #1e293b; border-radius: 12px; padding: 15px; border: 1px solid #334155; box-shadow: 0 4px 6px rgba(0,0,0,0.2); }
        h2 { margin: 0 0 15px 0; font-size: 18px; color: #94a3b8; font-weight: 600; display: flex; align-items: center; gap: 8px; }
        
        /* í…Œì´ë¸” */
        .table-container { overflow-x: auto; margin-top: 20px; }
        table { width: 100%; border-collapse: collapse; font-size: 13px; }
        th, td { padding: 10px; text-align: right; border-bottom: 1px solid #334155; }
        th { text-align: center; background: #0f172a; color: #64748b; position: sticky; top: 0; }
        tr:hover { background: #334155; }
        .text-call { color: #4ade80; } .text-put { color: #f87171; }
    </style>
</head>
<body>

    <div class="header">
        <h1>ğŸš€ OSCC Alpha Dashboard</h1>
        <div class="controls">
            <select id="tickerSelect"></select>
            <select id="expirySelect"></select>
        </div>
    </div>

    <div class="dashboard-grid">
        <div class="card">
            <h2>ğŸ“Š 1. Gamma Exposure (Volatility Map)</h2>
            <div id="chartGEX" style="height: 350px;"></div>
        </div>

        <div class="card">
            <h2>wall 2. Open Interest (Support/Resistance)</h2>
            <div id="chartOI" style="height: 350px;"></div>
        </div>

        <div class="card full-width">
            <h2>ğŸ“ˆ 3. Net GEX History (Market Regime Trend)</h2>
            <div id="chartTrend" style="height: 300px;"></div>
        </div>
    </div>

    <div class="card table-container">
        <h2>ğŸ“‹ Option Chain Details</h2>
        <table id="optionTable">
            <thead>
                <tr><th>Type</th><th>Strike</th><th>GEX ($)</th><th>OI</th><th>Vol</th><th>IV</th></tr>
            </thead>
            <tbody></tbody>
        </table>
    </div>

    <script>
        let gexData = [], summaryData = [];

        async function init() {
            try {
                // ë°ì´í„° ë³‘ë ¬ ë¡œë“œ
                const [resGex, resSum] = await Promise.all([
                    fetch('dashboard_gex_details.json'),
                    fetch('dashboard_summary.json')
                ]);
                gexData = await resGex.json();
                summaryData = await resSum.json();

                // ì¢…ëª© ë¦¬ìŠ¤íŠ¸ì—…
                const tickers = [...new Set(gexData.map(d => d.ticker))].sort();
                const selTicker = document.getElementById('tickerSelect');
                tickers.forEach(t => {
                    let opt = document.createElement('option');
                    opt.value = t; opt.text = `$${t}`;
                    selTicker.appendChild(opt);
                });

                selTicker.addEventListener('change', updateExpiry);
                document.getElementById('expirySelect').addEventListener('change', render);

                if(tickers.length > 0) updateExpiry();
            } catch(e) { console.error(e); }
        }

        function updateExpiry() {
            const ticker = document.getElementById('tickerSelect').value;
            const dates = [...new Set(gexData.filter(d => d.ticker === ticker).map(d => d.expiry))].sort();
            const selExp = document.getElementById('expirySelect');
            selExp.innerHTML = '';
            dates.forEach(d => {
                let opt = document.createElement('option');
                opt.value = d; opt.text = d;
                selExp.appendChild(opt);
            });
            render();
        }

        function render() {
            const ticker = document.getElementById('tickerSelect').value;
            const expiry = document.getElementById('expirySelect').value;
            
            // í•„í„°ë§
            const currentChain = gexData.filter(d => d.ticker === ticker && d.expiry === expiry)
                                        .sort((a,b) => a.strike - b.strike);
            const trendHistory = summaryData.filter(d => d.ticker === ticker);

            // 1. GEX Chart
            drawBarChart('chartGEX', currentChain, 'gex_notional', 'Gamma Exposure');
            
            // 2. OI Chart (Open Interest)
            drawBarChart('chartOI', currentChain, 'openInterest', 'Open Interest');

            // 3. Trend Chart (Net GEX History)
            drawTrendChart('chartTrend', trendHistory);

            // 4. Table
            drawTable(currentChain);
        }

        function drawBarChart(divId, data, key, label) {
            const calls = data.filter(d => d.type === 'call');
            const puts = data.filter(d => d.type === 'put');
            
            // OI ì°¨íŠ¸ì˜ ê²½ìš° Putë„ ì–‘ìˆ˜ë¡œ ë³´ì—¬ì£¼ëŠ”ê²Œ ì¼ë°˜ì ì´ë‚˜, GEX ìŠ¤íƒ€ì¼ ìœ ì§€ë¥¼ ìœ„í•´ 
            // ì—¬ê¸°ì„œëŠ” GEXëŠ” Putì´ ìŒìˆ˜, OIëŠ” Putì„ ìŒìˆ˜ì²˜ë¦¬í•˜ì§€ ì•ŠìŒ (ë¹„êµ ìš©ì´ì„±)
            // í•˜ì§€ë§Œ ì‚¬ìš©ì ìš”ì²­ì¸ 'ë²½'ì„ ë³´ë ¤ë©´ ì–‘ìˆ˜ë¡œ ì„¸ì›Œë‘ëŠ”ê²Œ ë‚˜ì„ ìˆ˜ ìˆìŒ.
            // ì—¬ê¸°ì„œëŠ” GEX ìŠ¤íƒ€ì¼(Call ìœ„, Put ì•„ë˜)ë¡œ í†µì¼í•©ë‹ˆë‹¤.
            
            const yPuts = key === 'openInterest' ? puts.map(d => -d[key]) : puts.map(d => d[key]);

            Plotly.newPlot(divId, [
                { x: calls.map(d => d.strike), y: calls.map(d => d[key]), type: 'bar', name: 'Call', marker: {color: '#4ade80'} },
                { x: puts.map(d => d.strike), y: yPuts, type: 'bar', name: 'Put', marker: {color: '#f87171'} }
            ], {
                barmode: 'relative', paper_bgcolor: 'rgba(0,0,0,0)', plot_bgcolor: 'rgba(0,0,0,0)',
                font: {color: '#94a3b8'}, margin: {t:10, b:30, l:40, r:10},
                xaxis: {gridcolor: '#334155'}, yaxis: {gridcolor: '#334155'}
            }, {responsive: true});
        }

        function drawTrendChart(divId, data) {
            Plotly.newPlot(divId, [{
                x: data.map(d => d.timestamp), y: data.map(d => d.net_gex_total),
                type: 'scatter', mode: 'lines+markers', line: {color: '#60a5fa', width: 3},
                fill: 'tozeroy'
            }], {
                paper_bgcolor: 'rgba(0,0,0,0)', plot_bgcolor: 'rgba(0,0,0,0)',
                font: {color: '#94a3b8'}, margin: {t:10, b:30, l:40, r:10},
                xaxis: {gridcolor: '#334155'}, yaxis: {gridcolor: '#334155', zerolinecolor: '#fff'}
            }, {responsive: true});
        }

        function drawTable(data) {
            const tbody = document.querySelector('#optionTable tbody');
            tbody.innerHTML = '';
            data.forEach(d => {
                let tr = document.createElement('tr');
                tr.innerHTML = `
                    <td class="text-center ${d.type==='call'?'text-call':'text-put'}">${d.type.toUpperCase()}</td>
                    <td style="font-weight:bold">${d.strike}</td>
                    <td>${Math.round(d.gex_notional).toLocaleString()}</td>
                    <td>${d.openInterest.toLocaleString()}</td>
                    <td>${d.volume.toLocaleString()}</td>
                    <td>${(d.impliedVolatility*100).toFixed(1)}%</td>
                `;
                tbody.appendChild(tr);
            });
        }

        init();
    </script>
</body>
</html>
