<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>OSCC Alpha Dashboard</title>
    <script src="https://cdn.plot.ly/plotly-2.27.0.min.js"></script>
    <style>
        /* ê¸°ë³¸ ì„¤ì • */
        body { 
            background-color: #0f172a; 
            color: #e2e8f0; 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            margin: 0; 
            padding: 15px; 
            -webkit-font-smoothing: antialiased;
        }

        /* í—¤ë” & ì»¨íŠ¸ë¡¤ */
        .header { 
            display: flex; 
            flex-direction: column; /* ëª¨ë°”ì¼: ì„¸ë¡œ ë°°ì¹˜ */
            gap: 15px; 
            margin-bottom: 25px; 
            border-bottom: 1px solid #334155; 
            padding-bottom: 15px; 
        }
        h1 { margin: 0; font-size: 24px; color: #38bdf8; }

        .controls { 
            display: flex; 
            gap: 10px; 
            width: 100%; 
        }
        select { 
            background: #1e293b; 
            color: #fff; 
            border: 1px solid #475569; 
            padding: 12px; 
            border-radius: 8px; 
            font-size: 16px; /* ëª¨ë°”ì¼ í„°ì¹˜ í¸í•˜ê²Œ í°íŠ¸ í‚¤ì›€ */
            flex: 1; /* í™”ë©´ ê½‰ ì°¨ê²Œ */
        }

        /* ğŸ“± í•µì‹¬: ë°˜ì‘í˜• ê·¸ë¦¬ë“œ ë ˆì´ì•„ì›ƒ */
        .dashboard-grid { 
            display: flex;
            flex-direction: column; /* ë¬´ì¡°ê±´ ì„¸ë¡œë¡œ ìŒ“ê¸° (ëª¨ë°”ì¼ ìš°ì„ ) */
            gap: 25px; 
            margin-bottom: 20px; 
        }

        /* PC í™”ë©´(768px ì´ìƒ)ì¼ ë•Œë§Œ 2ë‹¨ìœ¼ë¡œ ë³€ê²½ */
        @media (min-width: 1024px) {
            .header { flex-direction: row; justify-content: space-between; align-items: center; }
            .controls { width: auto; }
            .dashboard-grid { 
                display: grid; 
                grid-template-columns: 1fr 1fr; /* 2ë‹¨ ë¶„í•  */
            }
            .full-width { grid-column: 1 / -1; }
        }

        /* ì¹´ë“œ ìŠ¤íƒ€ì¼ */
        .card { 
            background: #1e293b; 
            border-radius: 16px; 
            padding: 15px; 
            border: 1px solid #334155; 
            box-shadow: 0 4px 6px rgba(0,0,0,0.3); 
            overflow: hidden; /* ì°¨íŠ¸ íŠ€ì–´ë‚˜ê° ë°©ì§€ */
        }
        
        h2 { 
            margin: 0 0 10px 0; 
            font-size: 18px; 
            color: #94a3b8; 
            font-weight: 600; 
            border-left: 4px solid #38bdf8;
            padding-left: 10px;
        }

        /* ì°¨íŠ¸ ë†’ì´ ê°•ì œ ì„¤ì • (ì¤‘ìš”) */
        .chart-container {
            width: 100%;
            height: 500px; /* ëª¨ë°”ì¼ì—ì„œ ì‹œì›í•˜ê²Œ ë³´ì´ë„ë¡ ë†’ì´ ì¦ê°€ */
        }

        /* í…Œì´ë¸” */
        .table-wrap { overflow-x: auto; -webkit-overflow-scrolling: touch; }
        table { width: 100%; border-collapse: collapse; font-size: 14px; white-space: nowrap; }
        th, td { padding: 12px; text-align: right; border-bottom: 1px solid #334155; }
        th { text-align: center; background: #0f172a; color: #94a3b8; position: sticky; top: 0; }
        .text-call { color: #4ade80; font-weight: bold; } 
        .text-put { color: #f87171; font-weight: bold; }
    </style>
</head>
<body>

    <div class="header">
        <h1>ğŸš€ OSCC Alpha</h1>
        <div class="controls">
            <select id="tickerSelect"></select>
            <select id="expirySelect"></select>
        </div>
    </div>

    <div class="dashboard-grid">
        <div class="card">
            <h2>ğŸ“Š 1. Gamma Exposure</h2>
            <div id="chartGEX" class="chart-container"></div>
        </div>

        <div class="card">
            <h2>ğŸ§± 2. Open Interest (Walls)</h2>
            <div id="chartOI" class="chart-container"></div>
        </div>

        <div class="card full-width">
            <h2>ğŸ“ˆ 3. Net GEX Trend</h2>
            <div id="chartTrend" class="chart-container" style="height: 350px;"></div>
        </div>
    </div>

    <div class="card">
        <h2>ğŸ“‹ Option Chain Details</h2>
        <div class="table-wrap">
            <table id="optionTable">
                <thead>
                    <tr><th>Type</th><th>Strike</th><th>GEX ($)</th><th>OI</th><th>Vol</th><th>IV</th></tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>
    </div>

    <script>
        let gexData = [], summaryData = [];

        async function init() {
            try {
                // ë°ì´í„° ë³‘ë ¬ ë¡œë“œ
                const [resGex, resSum] = await Promise.all([
                    fetch('dashboard_gex_details.json'),
                    fetch('dashboard_summary.json')
                ]);
                gexData = await resGex.json();
                summaryData = await resSum.json();

                // ì¢…ëª© ë¦¬ìŠ¤íŠ¸ì—…
                const tickers = [...new Set(gexData.map(d => d.ticker))].sort();
                const selTicker = document.getElementById('tickerSelect');
                tickers.forEach(t => {
                    let opt = document.createElement('option');
                    opt.value = t; opt.text = `$${t}`;
                    selTicker.appendChild(opt);
                });

                selTicker.addEventListener('change', updateExpiry);
                document.getElementById('expirySelect').addEventListener('change', render);

                if(tickers.length > 0) updateExpiry();
            } catch(e) { 
                console.error(e);
                document.querySelector('.header').insertAdjacentHTML('afterend', `<div style="color:red; text-align:center;">âŒ ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨. GitHub Actionì´ ì™„ë£Œë˜ì—ˆëŠ”ì§€ í™•ì¸í•˜ì„¸ìš”.</div>`);
            }
        }

        function updateExpiry() {
            const ticker = document.getElementById('tickerSelect').value;
            const dates = [...new Set(gexData.filter(d => d.ticker === ticker).map(d => d.expiry))].sort();
            const selExp = document.getElementById('expirySelect');
            selExp.innerHTML = '';
            dates.forEach(d => {
                let opt = document.createElement('option');
                opt.value = d; opt.text = d;
                selExp.appendChild(opt);
            });
            render();
        }

        function render() {
            const ticker = document.getElementById('tickerSelect').value;
            const expiry = document.getElementById('expirySelect').value;
            
            // í•„í„°ë§ ë° ì •ë ¬
            const currentChain = gexData.filter(d => d.ticker === ticker && d.expiry === expiry)
                                        .sort((a,b) => a.strike - b.strike);
            const trendHistory = summaryData.filter(d => d.ticker === ticker);

            // ì°¨íŠ¸ ê·¸ë¦¬ê¸°
            const commonLayout = {
                paper_bgcolor: 'rgba(0,0,0,0)', 
                plot_bgcolor: 'rgba(0,0,0,0)',
                font: {color: '#94a3b8', size: 11}, 
                margin: {t:30, b:40, l:50, r:10}, // ì—¬ë°± ìµœì†Œí™”í•˜ì—¬ ì°¨íŠ¸ ì˜ì—­ í™•ë³´
                xaxis: {gridcolor: '#334155', showgrid: true}, 
                yaxis: {gridcolor: '#334155', showgrid: true},
                legend: {orientation: 'h', y: 1.1} // ë²”ë¡€ ìƒë‹¨ ë°°ì¹˜
            };

            // 1. GEX Chart
            drawBarChart('chartGEX', currentChain, 'gex_notional', commonLayout);
            
            // 2. OI Chart
            drawBarChart('chartOI', currentChain, 'openInterest', commonLayout);

            // 3. Trend Chart
            drawTrendChart('chartTrend', trendHistory, commonLayout);

            // 4. Table
            drawTable(currentChain);
        }

        function drawBarChart(divId, data, key, layout) {
            const calls = data.filter(d => d.type === 'call');
            const puts = data.filter(d => d.type === 'put');
            
            // GEXëŠ” Putì„ ìŒìˆ˜ë¡œ, OIëŠ” ê·¸ëƒ¥ ì–‘ìˆ˜ë¡œ (ë²½ ë³´ê¸° ìœ„í•´)
            // ì‚¬ìš©ì í”¼ë“œë°±: "ë²½"ì„ ë³´ê³  ì‹¶ì–´í•¨ -> OIëŠ” ì–‘ìˆ˜ë¼ë¦¬ ë¹„êµí•˜ëŠ”ê²Œ ë‚˜ìŒ (Grouped Bar)
            // í•˜ì§€ë§Œ ê³µê°„ ì ˆì•½ì„ ìœ„í•´ Relative(ìœ„/ì•„ë˜) ìœ ì§€í•˜ë˜, OI Putì€ ìŒìˆ˜ë¡œ ë³€í™˜í•˜ì—¬ ì•„ë˜ë¡œ í‘œì‹œ
            
            const yPuts = puts.map(d => -d[key]); 

            Plotly.newPlot(divId, [
                { x: calls.map(d => d.strike), y: calls.map(d => d[key]), type: 'bar', name: 'Call', marker: {color: '#4ade80'} },
                { x: puts.map(d => d.strike), y: yPuts, type: 'bar', name: 'Put', marker: {color: '#f87171'} }
            ], {
                ...layout,
                barmode: 'relative' // ìœ„ì•„ë˜ë¡œ ìŒ“ê¸°
            }, {responsive: true, displayModeBar: false});
        }

        function drawTrendChart(divId, data, layout) {
            Plotly.newPlot(divId, [{
                x: data.map(d => d.timestamp), y: data.map(d => d.net_gex_total),
                type: 'scatter', mode: 'lines+markers', line: {color: '#38bdf8', width: 3},
                fill: 'tozeroy'
            }], {
                ...layout,
                margin: {t:10, b:30, l:40, r:10}
            }, {responsive: true, displayModeBar: false});
        }

        function drawTable(data) {
            const tbody = document.querySelector('#optionTable tbody');
            tbody.innerHTML = '';
            
            // ëª¨ë°”ì¼ì—ì„œ ë„ˆë¬´ ê¸¸ë©´ ìŠ¤í¬ë¡¤ í˜ë“œë‹ˆê¹Œ í•µì‹¬ ê°€ê²©ëŒ€(í˜„ì¬ê°€ ê·¼ì²˜)ë§Œ ë³´ì—¬ì£¼ê±°ë‚˜ ì „ì²´ ë³´ì—¬ì£¼ê¸°
            // ì—¬ê¸°ì„œëŠ” ì „ì²´ ë³´ì—¬ì£¼ë˜ CSSë¡œ ìŠ¤í¬ë¡¤ ì²˜ë¦¬í•¨
            data.forEach(d => {
                let tr = document.createElement('tr');
                tr.innerHTML = `
                    <td style="text-align:center" class="${d.type==='call'?'text-call':'text-put'}">${d.type.toUpperCase()}</td>
                    <td style="font-weight:bold; text-align:center">${d.strike}</td>
                    <td>${(d.gex_notional/1000).toFixed(1)}k</td> <td>${d.openInterest.toLocaleString()}</td>
                    <td>${d.volume.toLocaleString()}</td>
                    <td>${(d.impliedVolatility*100).toFixed(1)}%</td>
                `;
                tbody.appendChild(tr);
            });
        }

        init();
    </script>
</body>
</html>
