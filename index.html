<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OSCC Pro Dashboard</title>
    <script src="https://cdn.plot.ly/plotly-2.27.0.min.js"></script>
    <style>
        /* ë‹¤í¬ ëª¨ë“œ ìŠ¤íƒ€ì¼ë§ */
        body { background-color: #121212; color: #e0e0e0; font-family: 'Segoe UI', Roboto, sans-serif; margin: 0; padding: 20px; }
        
        /* ì»¨íŠ¸ë¡¤ íŒ¨ë„ (ë“œë¡­ë‹¤ìš´ ì˜ì—­) */
        .controls { background: #1e1e1e; padding: 15px; border-radius: 8px; margin-bottom: 20px; display: flex; gap: 20px; align-items: center; border: 1px solid #333; }
        select { background: #333; color: #fff; border: 1px solid #555; padding: 8px 12px; border-radius: 4px; font-size: 16px; outline: none; }
        label { font-weight: bold; color: #4caf50; }

        /* ì°¨íŠ¸ ì»¨í…Œì´ë„ˆ */
        .chart-box { background: #1e1e1e; padding: 20px; border-radius: 12px; margin-bottom: 20px; border: 1px solid #333; box-shadow: 0 4px 6px rgba(0,0,0,0.3); }

        /* í…Œì´ë¸” ìŠ¤íƒ€ì¼ë§ */
        .table-container { overflow-x: auto; background: #1e1e1e; border-radius: 12px; padding: 20px; border: 1px solid #333; }
        table { width: 100%; border-collapse: collapse; min-width: 600px; }
        th, td { padding: 12px; text-align: right; border-bottom: 1px solid #333; }
        th { text-align: center; background-color: #2c2c2c; color: #4caf50; position: sticky; top: 0; }
        td.text-center { text-align: center; }
        
        /* í…Œì´ë¸” ìƒ‰ìƒ ê°•ì¡° */
        .text-call { color: #4caf50; font-weight: bold; }
        .text-put { color: #ff5252; font-weight: bold; }
        tr:hover { background-color: #2a2a2a; }

        /* ìœ í‹¸ë¦¬í‹° */
        h2 { margin-top: 0; border-bottom: 1px solid #444; padding-bottom: 10px; }
        .loading { text-align: center; padding: 50px; color: #888; }
    </style>
</head>
<body>

    <div class="controls">
        <div>
            <label for="tickerSelect">Ticker:</label>
            <select id="tickerSelect"></select>
        </div>
        <div>
            <label for="expirySelect">Expiry Date:</label>
            <select id="expirySelect"></select>
        </div>
    </div>

    <div class="chart-box">
        <div id="gexChart"></div>
    </div>

    <div class="table-container">
        <h2>ğŸ“Š Option Chain Details</h2>
        <table id="optionTable">
            <thead>
                <tr>
                    <th>Type</th>
                    <th>Strike</th>
                    <th>GEX (Notional)</th>
                    <th>OI</th>
                    <th>Volume</th>
                    <th>IV</th>
                </tr>
            </thead>
            <tbody>
                </tbody>
        </table>
    </div>

    <script>
        let rawData = [];

        async function initDashboard() {
            try {
                // ë°ì´í„° ë¡œë“œ
                const response = await fetch('dashboard_gex_details.json');
                rawData = await response.json();

                // ì¢…ëª©(Ticker) ëª©ë¡ ì¶”ì¶œ ë° ë“œë¡­ë‹¤ìš´ ì±„ìš°ê¸°
                const tickers = [...new Set(rawData.map(d => d.ticker))].sort();
                const tickerSelect = document.getElementById('tickerSelect');
                
                tickers.forEach(t => {
                    const opt = document.createElement('option');
                    opt.value = t;
                    opt.text = `$${t}`;
                    tickerSelect.appendChild(opt);
                });

                // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ë“±ë¡
                tickerSelect.addEventListener('change', updateExpiryDropdown);
                document.getElementById('expirySelect').addEventListener('change', renderView);

                // ì´ˆê¸° ì‹¤í–‰
                if (tickers.length > 0) {
                    updateExpiryDropdown();
                }

            } catch (error) {
                document.querySelector('.chart-box').innerHTML = `<div class="loading">âŒ ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨: ${error.message}</div>`;
            }
        }

        // ì¢…ëª©ì´ ë°”ë€Œë©´ ë§Œê¸°ì¼ ëª©ë¡ì„ ì—…ë°ì´íŠ¸
        function updateExpiryDropdown() {
            const selectedTicker = document.getElementById('tickerSelect').value;
            const expirySelect = document.getElementById('expirySelect');
            expirySelect.innerHTML = ''; // ì´ˆê¸°í™”

            // í•´ë‹¹ ì¢…ëª©ì˜ ë°ì´í„°ë§Œ í•„í„°ë§
            const tickerData = rawData.filter(d => d.ticker === selectedTicker);
            // ë§Œê¸°ì¼ ëª©ë¡ ì¶”ì¶œ (ì¤‘ë³µì œê±° + ì •ë ¬)
            const expiries = [...new Set(tickerData.map(d => d.expiry))].sort();

            expiries.forEach(date => {
                const opt = document.createElement('option');
                opt.value = date;
                opt.text = date;
                expirySelect.appendChild(opt);
            });

            // ë§Œê¸°ì¼ì´ ì±„ì›Œì¡Œìœ¼ë©´ í™”ë©´ ë Œë”ë§
            if (expiries.length > 0) renderView();
        }

        // ì°¨íŠ¸ì™€ í…Œì´ë¸”ì„ ê·¸ë¦¬ëŠ” ë©”ì¸ í•¨ìˆ˜
        function renderView() {
            const ticker = document.getElementById('tickerSelect').value;
            const expiry = document.getElementById('expirySelect').value;
            
            // ë°ì´í„° í•„í„°ë§ (ì¢…ëª© + ë§Œê¸°ì¼)
            const currentData = rawData.filter(d => d.ticker === ticker && d.expiry === expiry);
            
            // í–‰ì‚¬ê°€(Strike) ê¸°ì¤€ìœ¼ë¡œ ì •ë ¬
            currentData.sort((a, b) => a.strike - b.strike);

            drawChart(currentData, ticker, expiry);
            drawTable(currentData);
        }

        // Plotly ì°¨íŠ¸ ê·¸ë¦¬ê¸°
        function drawChart(data, ticker, expiry) {
            const calls = data.filter(d => d.type === 'call');
            const puts = data.filter(d => d.type === 'put');

            const traceCall = {
                x: calls.map(d => d.strike),
                y: calls.map(d => d.gex_notional),
                name: 'Call GEX',
                type: 'bar',
                marker: { color: '#00e676' } // ë°ì€ ì´ˆë¡
            };

            const tracePut = {
                x: puts.map(d => d.strike),
                y: puts.map(d => d.gex_notional), // ì´ë¯¸ ìŒìˆ˜ê°’
                name: 'Put GEX',
                type: 'bar',
                marker: { color: '#ff1744' } // ë°ì€ ë¹¨ê°•
            };

            const layout = {
                title: { text: `$${ticker} Gamma Exposure - ${expiry}`, font: { color: '#fff' } },
                paper_bgcolor: 'rgba(0,0,0,0)',
                plot_bgcolor: 'rgba(0,0,0,0)',
                font: { color: '#aaa' },
                xaxis: { title: 'Strike Price', gridcolor: '#333' },
                yaxis: { title: 'Net Gamma Exposure ($)', gridcolor: '#333' },
                barmode: 'relative',
                margin: { t: 40, b: 40, l: 60, r: 20 },
                hovermode: 'x unified'
            };

            Plotly.newPlot('gexChart', [traceCall, tracePut], layout, {responsive: true});
        }

        // HTML í…Œì´ë¸” ê·¸ë¦¬ê¸°
        function drawTable(data) {
            const tbody = document.querySelector('#optionTable tbody');
            tbody.innerHTML = '';

            data.forEach(row => {
                const tr = document.createElement('tr');
                const isCall = row.type === 'call';
                const typeClass = isCall ? 'text-call' : 'text-put';
                const typeLabel = isCall ? 'CALL' : 'PUT';

                // ìˆ«ì í¬ë§·íŒ… (ì‰¼í‘œ ì¶”ê°€)
                const fmt = (num) => num ? num.toLocaleString() : '0';
                const gexFmt = (num) => num ? Math.round(num).toLocaleString() : '0';
                const ivFmt = (num) => num ? (num * 100).toFixed(1) + '%' : '-';

                tr.innerHTML = `
                    <td class="text-center ${typeClass}">${typeLabel}</td>
                    <td class="text-center"><b>$${row.strike}</b></td>
                    <td style="color: ${row.gex_notional > 0 ? '#00e676' : '#ff1744'}">${gexFmt(row.gex_notional)}</td>
                    <td>${fmt(row.openInterest)}</td>
                    <td>${fmt(row.volume)}</td>
                    <td>${ivFmt(row.impliedVolatility)}</td>
                `;
                tbody.appendChild(tr);
            });
        }

        // ì‹œì‘
        initDashboard();
    </script>
</body>
</html>
